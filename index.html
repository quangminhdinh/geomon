<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="description"
        content="GeoMon is a lightweight location-based RPG where players explore real-world maps, tap icons to battle enemies, and earn rewards. Unlike AR-heavy games, it offers quick, 2D turn-based fights for fun, accessible on-the-go gameplay.">
  <meta name="keywords" content="GeoMon">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GeoMon</title>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-PYVRSFMDRL"></script> -->
  <!-- <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'G-PYVRSFMDRL');
  </script> -->

  <link href="https://fonts.googleapis.com/css?family=Google+Sans|Noto+Sans|Castoro"
        rel="stylesheet">

  <link rel="stylesheet" href="./static/css/bulma.min.css">
  <link rel="stylesheet" href="./static/css/bulma-carousel.min.css">
  <link rel="stylesheet" href="./static/css/bulma-slider.min.css">
  <link rel="stylesheet" href="./static/css/fontawesome.all.min.css">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">
  <link rel="stylesheet" href="./static/css/index.css">
  <!-- <link rel="icon" href="./static/images/favicon.svg"> -->

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script defer src="./static/js/fontawesome.all.min.js"></script>
  <script src="./static/js/bulma-carousel.min.js"></script>
  <script src="./static/js/bulma-slider.min.js"></script>
  <script src="./static/js/index.js"></script>
</head>
<body>

<section class="hero">
  <div class="hero-body">
    <div class="container is-max-desktop">
      <div class="columns is-centered">
        <div class="column has-text-centered">
          <h1 class="title is-1 publication-title">GeoMon</h1>
          <div class="is-size-5 publication-authors">
            <span class="author-block">
              Quang Minh Dinh,</span>
            <span class="author-block">
              Brandon Arai,
            </span>
            <span class="author-block">
              Duc Long Nguyen,</span>
            <!-- <span class="author-block">
              Daniel Schlitt Ujvary,
            </span> -->
            <span class="author-block">
              Yizhang Zhu,
            </span>
          </div>

          <div class="is-size-5 publication-authors">
            <span class="author-block">{qmd, baa45, dln3, yza673}@sfu.ca,</span>
          </div>

          <div class="column has-text-centered">
            <div class="publication-links">
              <!-- <span class="link-block">
                <a href="https://arxiv.org/pdf/2011.12948"
                   class="external-link button is-normal is-rounded is-dark">
                  <span class="icon">
                      <i class="fas fa-file-pdf"></i>
                  </span>
                  <span>Paper</span>
                </a>
              </span>
              <span class="link-block">
                <a href="https://arxiv.org/abs/2011.12948"
                   class="external-link button is-normal is-rounded is-dark">
                  <span class="icon">
                      <i class="ai ai-arxiv"></i>
                  </span>
                  <span>arXiv</span>
                </a>
              </span> -->
              <!-- <span class="link-block">
                <a href="https://www.youtube.com/watch?v=MrKrnHhk8IA"
                   class="external-link button is-normal is-rounded is-dark">
                  <span class="icon">
                      <i class="fab fa-youtube"></i>
                  </span>
                  <span>Video</span>
                </a>
              </span> -->
              <span class="link-block">
                <a href="https://github.com/quangminhdinh/geomon_cmpt362"
                   class="external-link button is-normal is-rounded is-dark">
                  <span class="icon">
                      <i class="fab fa-github"></i>
                  </span>
                  <span>Code</span>
                  </a>
              </span>
              <span class="link-block">
                <a href="https://drive.google.com/file/d/1uIQKGibYHKj9n446kfQ_-h_WOfwIi4Z3/view?usp=sharing"
                   class="external-link button is-normal is-rounded is-dark">
                  <span class="icon">
                      <i class="fa fa-mobile-alt"></i>
                  </span>
                  <span>Demo</span>
                  </a>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- <section class="hero teaser">
  <div class="container is-max-desktop">
    <div class="hero-body">
     <iframe width="560" height="315" src="https://www.youtube.com/embed/O8q0oeOwNfc?si=QBwW4l7qufgSQxUu" frameborder="0" allow="autoplay; encrypted-media" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
     
      <video id="teaser" autoplay muted loop playsinline height="100%">
        <source src="./static/videos/teaser.mp4"
                type="video/mp4">
      </video>
    </div>
  </div>
</section> -->


<!-- <section class="hero is-light is-small">
  <div class="hero-body">
    <div class="container">
      <div id="results-carousel" class="carousel results-carousel">
        <div class="item item-steve">
          <video poster="" id="steve" autoplay controls muted loop playsinline height="100%">
            <source src="./static/videos/steve.mp4"
                    type="video/mp4">
          </video>
        </div>
        <div class="item item-chair-tp">
          <video poster="" id="chair-tp" autoplay controls muted loop playsinline height="100%">
            <source src="./static/videos/chair-tp.mp4"
                    type="video/mp4">
          </video>
        </div>
        <div class="item item-shiba">
          <video poster="" id="shiba" autoplay controls muted loop playsinline height="100%">
            <source src="./static/videos/shiba.mp4"
                    type="video/mp4">
          </video>
        </div>
        <div class="item item-fullbody">
          <video poster="" id="fullbody" autoplay controls muted loop playsinline height="100%">
            <source src="./static/videos/fullbody.mp4"
                    type="video/mp4">
          </video>
        </div>
        <div class="item item-blueshirt">
          <video poster="" id="blueshirt" autoplay controls muted loop playsinline height="100%">
            <source src="./static/videos/blueshirt.mp4"
                    type="video/mp4">
          </video>
        </div>
        <div class="item item-mask">
          <video poster="" id="mask" autoplay controls muted loop playsinline height="100%">
            <source src="./static/videos/mask.mp4"
                    type="video/mp4">
          </video>
        </div>
        <div class="item item-coffee">
          <video poster="" id="coffee" autoplay controls muted loop playsinline height="100%">
            <source src="./static/videos/coffee.mp4"
                    type="video/mp4">
          </video>
        </div>
        <div class="item item-toby">
          <video poster="" id="toby" autoplay controls muted loop playsinline height="100%">
            <source src="./static/videos/toby2.mp4"
                    type="video/mp4">
          </video>
        </div>
      </div>
    </div>
  </div>
</section> -->


<section class="section" style="padding-top: 0;">
  <div class="container is-max-desktop">
    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <div class="publication-video">
          <!-- <iframe src="https://www.youtube.com/embed/MrKrnHhk8IA?rel=0&amp;showinfo=0"
                  frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe> -->
          <iframe src="https://www.youtube.com/embed/0FHlLX5ixUo?si=EiKvSnZg8H2bC7O4" frameborder="0" allow="autoplay; encrypted-media" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
        </div>
      </div>
    </div>
    <!-- Abstract. -->
    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <!-- <h2 class="title is-3">Abstract</h2> -->
        <div class="content has-text-justified">
          <p>
            GeoMon is a lightweight location-based RPG where players explore real-world maps, tap icons to battle enemies, and earn rewards. Unlike AR-heavy games, it offers quick, 2D turn-based fights for fun, accessible on-the-go gameplay.
          </p>
          <!-- <p>
            Our approach augments neural radiance fields
            (NeRF) by optimizing an
            additional continuous volumetric deformation field that warps each observed point into a
            canonical 5D NeRF.
            We observe that these NeRF-like deformation fields are prone to local minima, and
            propose a coarse-to-fine optimization method for coordinate-based models that allows for
            more robust optimization.
            By adapting principles from geometry processing and physical simulation to NeRF-like
            models, we propose an elastic regularization of the deformation field that further
            improves robustness.
          </p>
          <p>
            We show that <span class="dnerf">Nerfies</span> can turn casually captured selfie
            photos/videos into deformable NeRF
            models that allow for photorealistic renderings of the subject from arbitrary
            viewpoints, which we dub <i>"nerfies"</i>. We evaluate our method by collecting data
            using a
            rig with two mobile phones that take time-synchronized photos, yielding train/validation
            images of the same pose at different viewpoints. We show that our method faithfully
            reconstructs non-rigidly deforming scenes and reproduces unseen views with high
            fidelity.
          </p> -->
        </div>
      </div>
    </div>

    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <h2 class="title is-3">Demo 2 video</h2>
        <div class="publication-video">
          <!-- <iframe src="https://www.youtube.com/embed/MrKrnHhk8IA?rel=0&amp;showinfo=0"
                  frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe> -->
          <iframe src="https://www.youtube.com/embed/kmky_mS402U?si=xJfqc1okdlHQb7Hs" frameborder="0" allow="autoplay; encrypted-media" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
        </div>
      </div>
    </div>

    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <h2 class="title is-3">Demo 1 video</h2>
        <div class="publication-video">
          <!-- <iframe src="https://www.youtube.com/embed/MrKrnHhk8IA?rel=0&amp;showinfo=0"
                  frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe> -->
          <iframe src="https://www.youtube.com/embed/O8q0oeOwNfc?si=9Skv45NDox8k1bbN" frameborder="0" allow="autoplay; encrypted-media" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
        </div>
      </div>
    </div>

    <!--/ Abstract. -->
    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <h2 class="title is-3">Threaded Design Diagram</h2>
      </div>
    </div>

    <pre>                          ┌─────────────────────────────────────────────────────┐
                          │                    UI THREAD                        │
                          │                (Main / Looper Main)                 │
                          └─────────────────────────────────────────────────────┘
                                          ▲                 ▲
                                          │                 │
                                          │                 │
                               UI Updates │                 │ LiveData Observers
                                          │                 │
┌─────────────────────────┐               │                 │             ┌─────────────────────────┐
│       MainActivity      │───────────────┘                 └────────────>│   TrackingViewModel     │
│ - onCreate              │                                               │ - LiveData<LatLng>      │
│ - onResume              │                                               │ - serviceStarted        │
│ - onMapReady            │                                               │ - TrackingHandler       │
│ - updateMap             │                                               │   (Looper.Main)         │
│ - displayOtherPlayers   │                                               └─────────────────────────┘
│ - handlePlayerClick     │
│ - setupDuelListener     │
│ - showDuelDialog        │
│ - createBattleState     │
│ - launchBattle          │
│ - marker clicks         │
│ - heartbeat handler     │
│   (30s intervals)       │
└─────────────────────────┘
          ▲
          │ UI interactions
          │
┌─────────────────────────┐   ┌─────────────────────────┐   ┌─────────────────────────┐
│     BattleActivity      │   │  MonsterChatDialog      │   │   BagActivity           │
│ - onCreate              │   │ - onCreate              │   │ - loadUserBag           │
│ - setupMoveButtons      │   │ - sendMessage           │   │ - onItemClicked         │
│ - onPlayerMoveSelected  │   │ - GeminiAPI calls       │   │ - openHealTarget        │
│ - handlePvPMove         │   │ - chat UI updates       │   │ - openLevelUpTarget     │
│ - handlePvEMove         │   └─────────────────────────┘   └─────────────────────────┘
│ - performAttack         │
│ - checkBattleEnd        │   ┌─────────────────────────┐   ┌─────────────────────────┐
│ - setupBattleListener   │   │  HealTargetActivity     │   │  AllTargetActivity      │
│ - updateHpFromState     │   │ - loadDamagedMonsters   │   │ - loadAllMonsters       │
│ - coroutine delays      │   │ - onMonsterClicked      │   │ - onMonsterClicked      │
│ - lastMoveTimestamp     │   │ - heal & Firebase sync  │   │ - levelUp & sync        │
└─────────────────────────┘   └─────────────────────────┘   └─────────────────────────┘

┌─────────────────────────┐   ┌─────────────────────────┐   ┌─────────────────────────┐
│   PokedexActivity       │   │  MonsterInfoActivity    │   │  MenuDialogFragment     │
│ - loadUserMonsters      │   │ - fetchById (coroutine) │   │ - openMonsterChat       │
│ - launch MonsterInfo    │   │ - bindMonster           │   │ - launch activities     │
└─────────────────────────┘   │ - setBattle button      │   └─────────────────────────┘
                              └─────────────────────────┘
┌─────────────────────────┐   ┌─────────────────────────┐
│ ChangeAvatarDialog      │   │  PlayerStatsDialog      │
│ - image picker          │   │ - fetchById user        │
│ - Firebase Storage      │   │ - fetchById monster     │
│ - Glide avatar load     │   │ - Glide avatar load     │
└─────────────────────────┘   └─────────────────────────┘

───────────────────────────────────────────────────────────────────────────────
                 BACKGROUND THREADS (COROUTINES / ROOM / FIREBASE)
───────────────────────────────────────────────────────────────────────────────

            ┌─────────────────────────────┐
            │      Dispatchers.IO         │
            │ (Coroutine thread pool)     │
            └─────────────────────────────┘
                    ▲                          ▲                    ▲
                    │                          │                    │
    MainActivity.onCreate background work      │                    │
    ┌─────────────────────────────┐        Room DB                  │
    │ lifecycleScope.launch(IO)   │       auto-threading            │
    │ - signInAnonymously()       │        ┌──────────────────────────┐
    │ - Seeder.run()              │◄──────►│ SpeciesDao (suspend)     │
    │ - load stats.json           │        │ - upsertAll()            │
    │ - load moves.json           │        │ - upsertMoves()          │
    │ - load items.json           │        │ - upsertItems()          │
    │ - parse species/moves/items │        │ - getById()              │
    │ - User.fetchById()          │        │ - getAll()               │
    │ - Monster.fetchById()       │        │ - getByIdNow()           │
    │ - Monster.initializeByName()│        │ - getMoveByIdNow()       │
    │ - User.createOrUpdate()     │        │ - getItemByDisplayName() │
    │ - generateAndUploadMonsters │        │ - countSpecies()         │
    │ - fetchNearbyMonsters       │        └──────────────────────────┘
    └─────────────────────────────┘

SpeciesRepository
┌──────────────────────────────────────────┐
│ clear() → CoroutineScope(IO).launch      │──► IO THREAD
│ getAllSpecies() (Flow)                   │◄── ROOM THREAD
│ upsertAll(), upsertMoves() (suspend)     │──► ROOM THREAD
│ upsertItems() (suspend)                  │──► ROOM THREAD
│ countSpecies() (suspend)                 │──► ROOM THREAD
└──────────────────────────────────────────┘

Seeder
┌─────────────────────────────────────────────┐
│ run(context, repo)                          │
│ - withContext(IO)                           │──► JSON parsing thread
│ - load raw/stats.json                       │
│ - load raw/moves.json                       │
│ - load raw/items.json                       │
│ - construct Species/Move/Item objects       │
│ - insert via repository (Room → IO thread)  │
└─────────────────────────────────────────────┘

Monster Companion Object
┌──────────────────────────────────────────┐
│ initializeByName(name)                   │
│   - DB lookup (Room on IO)               │
│   - fallback to default                  │
│   - levelScaling calculation             │
│   - Firebase push & setValue             │──► Firebase thread
│ fetchById(id)                            │
│   - suspendCoroutine                     │
│   - Firebase .get()                      │──► Firebase threadpool
│   - fromSnapshot parsing                 │
│   - levelScaling on result               │
│   - continuation.resume() on main thread │──► MAIN THREAD
│ setOwner(monsterId, ownerId)             │──► Firebase thread
│ takeDamage(damage)                       │
│   - syncHpToFirebase()                   │──► Firebase thread
│ healDamage(amount)                       │
│   - syncHpToFirebase()                   │──► Firebase thread
│ levelUp(amount)                          │
│   - levelScaling(this)                   │
│   - syncHpToFirebase()                   │──► Firebase thread
└──────────────────────────────────────────┘

Move Companion Object
┌──────────────────────────────────────────┐
│ initializeByName(context, name)          │
│   - DB lookup (Room on IO)               │──► Room thread
│   - fallback to hardcoded moves          │
│   - fromEntity conversion                │
└──────────────────────────────────────────┘

Item Companion Object
┌──────────────────────────────────────────┐
│ searchByDisplayName(context, name)       │
│   - DB lookup (Room on IO)               │──► Room thread
│   - fromEntity conversion                │
│ returnAffect()                           │
│   - effect parsing logic                 │
└──────────────────────────────────────────┘

Battle Logic (background portions)
┌──────────────────────────────────────────┐
│ BattleActivity                           │
│   lifecycleScope.launch {                │
│      - Monster.fetchById() (player)      │──► Firebase thread
│      - Monster.fetchById() (opponent)    │──► Firebase thread
│      - Move.initializeByName()           │──► Room thread
│      - damageCalc()                      │──► Calculation (current thread)
│      - performAttack()                   │
│      - delay(800-1000ms)                 │──► Default dispatcher
│      - checkBattleEnd()                  │
│      - giveVictoryRewards()              │
│      - handlePvPVictory()                │
│      - handlePvPDefeat()                 │
│   }                                      │
│                                          │
│ PvP-specific:                            │
│   - setupBattleStateListener()           │
│      - ValueEventListener                │──► Firebase thread
│      - onDataChange callback             │──► Main thread
│      - updateHpFromBattleState()         │
│      - lastProcessedMoveTimestamp check  │
│   - handlePvPMoveSelection()             │
│      - performAttack()                   │
│      - BattleState.updateHpAndNextTurn() │──► Firebase thread
└──────────────────────────────────────────┘

───────────────────────────────────────────────────────────────────────────────
                              SPAWN SYSTEM THREADING
───────────────────────────────────────────────────────────────────────────────

Monster Spawning
┌──────────────────────────────────────────┐
│ MainActivity.checkAndSpawnMonsters()     │
│   - Firebase addListenerForSingleValue   │──► Firebase thread
│   - onDataChange callback                │──► Main thread
│   - count nearby monsters                │
│   - if < threshold:                      │
│     generateAndUploadMonsters()          │
│       - lifecycleScope.launch(IO)        │──► IO thread
│       - for each monster:                │
│         Monster.initializeByName()       │──► Room + Firebase
│   - displayMonstersOnMap()               │──► Main thread
│     - add markers to GoogleMap           │
└──────────────────────────────────────────┘

Item Spawning
┌──────────────────────────────────────────┐
│ ItemSpawner.generateItemsAround()        │
│   - deterministic grid-based generation  │──► Current thread
│   - uses seeded Random per grid cell     │
│   - returns List<ItemSpawn>              │
│                                          │
│ MainActivity.checkAndSpawnItems()        │──► Main thread
│   - calls ItemSpawner.generateItems()    │
│   - displayItemsOnMap()                  │
│     - add markers to GoogleMap           │
└──────────────────────────────────────────┘

───────────────────────────────────────────────────────────────────────────────
                      FIREBASE THREADS (NETWORK OPERATIONS)
───────────────────────────────────────────────────────────────────────────────

                   ┌─────────────────────────────────────────┐
                   │ Firebase Internal Worker Threadpool     │
                   └─────────────────────────────────────────┘
                            ▲                     ▲
                            │                     │
         Monster operations │                     │ User/Auth operations
         ┌──────────────────────────────┐         ┌───────────────────────────────────────┐
         │ Monster.fetchById()          │         │ User.fetchById()                      │
         │ - suspendCoroutine           │         │   - Firebase .get()                   │
         │ - reference.child(id).get()  │         │   - fromSnapshot parsing              │
         │ - fromSnapshot               │         │ User.createOrUpdate()                 │
         │ - SuccessListener runs here  │         │   - Firebase setValue()               │
         │ - resume on main thread      │         │ User.updateLocation()                 │
         │                              │         │   - Firebase updateChildren().        │
         │ Monster.initializeByName()   │         │ User.updateLastActive()               │
         │ - Firebase push().setValue() │         │   - Firebase updateChildren().        │
         │                              │         │ User.updateAvatarUrl()                │
         │ Monster.takeDamage()         │         │   - Firebase updateChildren().        │
         │ - Firebase updateChildren()  │         │ User.addMonster()                     │
         │   (currentHp sync)           │         │   - Firebase .get() + setValue().     │
         │                              │         │ User.removeMonster()                  │
         │ Monster.setOwner()           │         │   - Firebase .get() + updateChildren()│
         │ - Firebase setValue()        │         │ User.setUserActiveMonster()           │
         │                              │         │   - Firebase updateChildren().        │
         │ Monster.levelUp()            │         │ User.addItem()                        │
         │ - syncHpToFirebase()         │         │   - Firebase .get() + updateBag().    │
         │                              │         │ User.removeByItemName()               │
         │ Monster.healDamage()         │         │   - Firebase .get() + updateBag().    │
         │ - syncHpToFirebase()         │         │ User.updateBag()                      │
         └──────────────────────────────┘         │   - Firebase updateChildren().        │
                                                  └───────────────────────────────────────┘

DuelRequest Firebase Operations
┌──────────────────────────────────────────┐
│ DuelRequest.create()                     │──► Firebase thread
│   - suspendCoroutine                     │
│   - push().setValue()                    │
│ DuelRequest.updateStatus()               │──► Firebase thread
│   - updateChildren()                     │
│ DuelRequest.setBattleReady()             │──► Firebase thread
│   - updateChildren()                     │
│ DuelRequest.delete()                     │──► Firebase thread
│   - removeValue()                        │
│                                          │
│ MainActivity.setupDuelRequestListener()  │
│   - ValueEventListener                   │──► Firebase thread
│   - onDataChange callback                │──► Main thread
│   - showDuelChallengeDialog()            │
└──────────────────────────────────────────┘

BattleState Firebase Operations
┌──────────────────────────────────────────┐
│ BattleState.create()                     │──► Firebase thread
│   - suspendCoroutine                     │
│   - push().setValue()                    │
│ BattleState.updateMove()                 │──► Firebase thread
│   - .get() + updateChildren()            │
│ BattleState.updateHpAndNextTurn()        │──► Firebase thread
│   - updateChildren()                     │
│   - includes: player1Hp, player2Hp,      │
│     currentTurn, lastMove, lastMoveUser  │
│ BattleState.finishBattle()               │──► Firebase thread
│   - updateChildren()                     │
│ BattleState.delete()                     │──► Firebase thread
│   - removeValue()                        │
│                                          │
│ BattleActivity.setupBattleStateListener()│
│   - ValueEventListener                   │──► Firebase thread
│   - onDataChange callback                │──► Main thread
│   - updateHpFromBattleState()            │
│   - timestamp checking                   │
└──────────────────────────────────────────┘

AuthManager Firebase Operations
┌──────────────────────────────────────────┐
│ signInAnonymously()                      │
│   - suspendCoroutine                     │──► Firebase Auth thread
│   - auth.signInAnonymously()             │
│   - resume on callback                   │
│ signOut()                                │──► Firebase Auth thread
│ addAuthStateListener()                   │
│ removeAuthStateListener()                │
└──────────────────────────────────────────┘

Firebase Storage (Avatar Upload)
┌──────────────────────────────────────────┐
│ ChangeAvatarDialogFragment               │
│ - uploadAvatar()                         │
│   - lifecycleScope.launch                │
│   - putFile(uri).await()                 │──► Storage thread
│   - getDownloadUrl().await()             │──► Storage thread
│   - User.updateAvatarUrl()               │──► Firebase thread
└──────────────────────────────────────────┘

───────────────────────────────────────────────────────────────────────────────
                           LOCATION SERVICE THREADING
───────────────────────────────────────────────────────────────────────────────

GPS/Location Provider Thread
┌──────────────────────────────────────────┐
│ TrackingService                          │
│ - onStartCommand()                       │
│ - requestLocationUpdates()               │
│   (callback on NON-UI location thread)   │
│ - onLocationChanged(location)            │
│   (called on location thread)            │
│   → creates Bundle                       │
│   → sends Message to Handler             │──► Main thread via Handler
└──────────────────────────────────────────┘
                    │
                    ▼
     TrackingMessageHandler (MAIN THREAD)
     │ - handleMessage(msg)  
     │ - extracts lat/lng from Bundle
     │ - updates TrackingViewModel._latLng (MutableLiveData)
     ▼
UI THREAD observes latLng.value changes
     │ - MainActivity.updateMap()
     │   - CameraUpdateFactory.newLatLngZoom()
     │   - googleMap.animateCamera()
     │   - update player marker with direction icon
     │   - User.updateLocation()               ──► Firebase thread
     │   - checkAndSpawnMonsters()
     │   - checkAndSpawnItems()
     │   - displayOtherPlayers()
     │   - calculateDirection()

───────────────────────────────────────────────────────────────────────────────
                         MULTIPLAYER THREADING (PvP)
───────────────────────────────────────────────────────────────────────────────

Other Players Display
┌──────────────────────────────────────────┐
│ MainActivity.displayOtherPlayers()       │
│   - Firebase ValueEventListener          │──► Firebase thread
│   - onDataChange callback                │──► Main thread
│   - filter by lastActive (5 min)         │
│   - filter by radius                     │
│   - for each nearby player:              │
│     - Glide.asBitmap().load(avatarUrl)   │──► Glide thread pool
│       - CustomTarget callback            │──► Main thread
│       - cache avatar bitmap              │
│       - updateOtherPlayerMarker()        │
│   - remove markers for departed players  │
└──────────────────────────────────────────┘

Duel Challenge Flow
┌──────────────────────────────────────────┐
│ 1. Marker Click (Other Player)           │──► Main thread
│    - handlePlayerMarkerClick()           │
│      - lifecycleScope.launch             │
│      - User.fetchById (current & target) │──► Firebase thread
│      - Monster.fetchById (check fainted) │──► Firebase thread
│      - show AlertDialog (challenge)      │──► Main thread
│      - sendDuelRequest()                 │
│        - DuelRequest.create()            │──► Firebase thread
│                                          │
│ 2. Receive Challenge                     │
│    - setupDuelRequestListener()          │──► Firebase thread
│      - ValueEventListener.onDataChange   │──► Main thread
│      - showDuelChallengeDialog()         │──► Main thread
│      - on Accept:                        │
│        - lifecycleScope.launch           │
│        - check active monster            │──► Firebase thread
│        - DuelRequest.updateStatus()      │──► Firebase thread
│                                          │
│ 3. Create Battle                         │
│    - challenger sees "accepted" status   │──► Firebase listener
│    - createBattleState()                 │
│      - lifecycleScope.launch             │
│      - User.fetchById (both players)     │──► Firebase thread
│      - Monster.fetchById (both monsters) │──► Firebase thread
│      - BattleState.create()              │──► Firebase thread
│      - DuelRequest.setBattleReady()      │──► Firebase thread
│                                          │
│ 4. Launch Battle                         │
│    - both players see "battle_ready"     │──► Firebase listener
│    - launchBattleFromRequest()           │
│      - lifecycleScope.launch             │
│      - User.fetchById (opponent)         │──► Firebase thread
│      - startActivity(BattleActivity)     │──► Main thread
│      - DuelRequest.delete()              │──► Firebase thread
└──────────────────────────────────────────┘

PvP Battle Synchronization
┌──────────────────────────────────────────┐
│ BattleActivity (PvP Mode)                │
│                                          │
│ setupBattleStateListener()               │
│   - ValueEventListener                   │──► Firebase thread
│   - onDataChange callback                │──► Main thread
│   - check lastMoveTimestamp              │
│   - updateHpFromBattleState()            │
│   - determine isMyTurn                   │
│   - if opponent moved:                   │
│     - show opponent's move               │
│     - update HP displays                 │
│     - check if battle finished           │
│   - if myTurn:                           │
│     - enable move buttons                │
│                                          │
│ handlePvPMoveSelection()                 │
│   - check isMyTurn                       │──► Main thread
│   - lifecycleScope.launch                │
│   - Move.initializeByName()              │──► Room thread
│   - performAttack()                      │
│   - delay(1000)                          │
│   - BattleState.updateHpAndNextTurn()    │──► Firebase thread
│   - checkBattleEnd()                     │
│                                          │
│ checkBattleEnd()                         │
│   - if monster fainted:                  │
│     - BattleState.finishBattle()         │──► Firebase thread
│     - handlePvPVictory() / Defeat()      │
│       - User.removeByItemName()          │──► Firebase thread
│       - User.addItem()                   │──► Firebase thread
│     - delay(2000)                        │
│     - finish()                           │──► Main thread
└──────────────────────────────────────────┘

───────────────────────────────────────────────────────────────────────────────
                          AI CHAT THREADING (GEMINI API)
───────────────────────────────────────────────────────────────────────────────

GeminiAPI
┌──────────────────────────────────────────┐
│ generateContent(prompt)                  │
│   - withContext(Dispatchers.IO)          │──► IO thread
│   - HttpURLConnection setup              │
│   - POST to Gemini API                   │──► Network thread
│   - read response                        │
│   - parseResponse(json)                  │
│   - return text                          │
└──────────────────────────────────────────┘

MonsterAI
┌──────────────────────────────────────────┐
│ initialize(context)                      │──► Main thread
│   - read API key from manifest           │
│   - GeminiAPI.setApiKey()                │
│                                          │
│ getChatResponse()                        │
│   - withContext(Dispatchers.IO)          │──► IO thread
│   - buildChatPrompt()                    │
│   - GeminiAPI.generateContent()          │──► IO thread
│   - return response                      │
└──────────────────────────────────────────┘

MonsterChatDialogFragment
┌──────────────────────────────────────────┐
│ loadMonsterData()                        │
│   - lifecycleScope.launch(IO)            │──► IO thread
│   - Monster.fetchById()                  │──► Firebase thread
│   - withContext(Main)                    │──► Main thread
│   - generateWelcomeMessage()             │
│                                          │
│ sendMessage()                            │──► Main thread
│   - showLoading(true)                    │
│   - lifecycleScope.launch                │
│   - MonsterAI.getChatResponse()          │──► IO thread
│   - addMonsterMessage()                  │──► Main thread
│   - showLoading(false)                   │
└──────────────────────────────────────────┘

</pre>

    <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
      </div>
    </div>

    <!-- Paper video. -->
    <!-- <div class="columns is-centered has-text-centered">
      <div class="column is-four-fifths">
        <h2 class="title is-3">MVVM diagram</h2>
        <div class="publication-video">
          <img src="./static/images/MVVM.png"
                 class="interpolation-image"
                 alt="MVVM diagram"/>
        </div>
      </div>
    </div> -->
    <!--/ Paper video. -->
  </div>
</section>


<!-- <section class="section">
  <div class="container is-max-desktop">

    <div class="columns is-centered">

      Visual Effects.
      <div class="column">
        <div class="content">
          <h2 class="title is-3">Visual Effects</h2>
          <p>
            Using <i>nerfies</i> you can create fun visual effects. This Dolly zoom effect
            would be impossible without nerfies since it would require going through a wall.
          </p>
          <video id="dollyzoom" autoplay controls muted loop playsinline height="100%">
            <source src="./static/videos/dollyzoom-stacked.mp4"
                    type="video/mp4">
          </video>
        </div>
      </div>
      / Visual Effects.

      Matting.
      <div class="column">
        <h2 class="title is-3">Matting</h2>
        <div class="columns is-centered">
          <div class="column content">
            <p>
              As a byproduct of our method, we can also solve the matting problem by ignoring
              samples that fall outside of a bounding box during rendering.
            </p>
            <video id="matting-video" controls playsinline height="100%">
              <source src="./static/videos/matting.mp4"
                      type="video/mp4">
            </video>
          </div>

        </div>
      </div>
    </div>
    / Matting.

    Animation.
    <div class="columns is-centered">
      <div class="column is-full-width">
        <h2 class="title is-3">Animation</h2>

        <h3 class="title is-4">Interpolating states</h3>
        <div class="content has-text-justified">
          <p>
            We can also animate the scene by interpolating the deformation latent codes of two input
            frames. Use the slider here to linearly interpolate between the left frame and the right
            frame.
          </p>
        </div>
        <div class="columns is-vcentered interpolation-panel">
          <div class="column is-3 has-text-centered">
            <img src="./static/images/interpolate_start.jpg"
                 class="interpolation-image"
                 alt="Interpolate start reference image."/>
            <p>Start Frame</p>
          </div>
          <div class="column interpolation-video-column">
            <div id="interpolation-image-wrapper">
              Loading...
            </div>
            <input class="slider is-fullwidth is-large is-info"
                   id="interpolation-slider"
                   step="1" min="0" max="100" value="0" type="range">
          </div>
          <div class="column is-3 has-text-centered">
            <img src="./static/images/interpolate_end.jpg"
                 class="interpolation-image"
                 alt="Interpolation end reference image."/>
            <p class="is-bold">End Frame</p>
          </div>
        </div>
        <br/>

        <h3 class="title is-4">Re-rendering the input video</h3>
        <div class="content has-text-justified">
          <p>
            Using <span class="dnerf">Nerfies</span>, you can re-render a video from a novel
            viewpoint such as a stabilized camera by playing back the training deformations.
          </p>
        </div>
        <div class="content has-text-centered">
          <video id="replay-video"
                 controls
                 muted
                 preload
                 playsinline
                 width="75%">
            <source src="./static/videos/replay.mp4"
                    type="video/mp4">
          </video>
        </div>

      </div>
    </div> -->
    <!--/ Animation. -->


    <!-- Concurrent Work. -->
    <!-- <div class="columns is-centered">
      <div class="column is-full-width">
        <h2 class="title is-3">Related Links</h2>

        <div class="content has-text-justified">
          <p>
            There's a lot of excellent work that was introduced around the same time as ours.
          </p>
          <p>
            <a href="https://arxiv.org/abs/2104.09125">Progressive Encoding for Neural Optimization</a> introduces an idea similar to our windowed position encoding for coarse-to-fine optimization.
          </p>
          <p>
            <a href="https://www.albertpumarola.com/research/D-NeRF/index.html">D-NeRF</a> and <a href="https://gvv.mpi-inf.mpg.de/projects/nonrigid_nerf/">NR-NeRF</a>
            both use deformation fields to model non-rigid scenes.
          </p>
          <p>
            Some works model videos with a NeRF by directly modulating the density, such as <a href="https://video-nerf.github.io/">Video-NeRF</a>, <a href="https://www.cs.cornell.edu/~zl548/NSFF/">NSFF</a>, and <a href="https://neural-3d-video.github.io/">DyNeRF</a>
          </p>
          <p>
            There are probably many more by the time you are reading this. Check out <a href="https://dellaert.github.io/NeRF/">Frank Dellart's survey on recent NeRF papers</a>, and <a href="https://github.com/yenchenlin/awesome-NeRF">Yen-Chen Lin's curated list of NeRF papers</a>.
          </p>
        </div>
      </div>
    </div> -->
    <!--/ Concurrent Work. -->

  <!-- </div>
</section> -->


<!-- <section class="section" id="BibTeX">
  <div class="container is-max-desktop content">
    <h2 class="title">BibTeX</h2>
    <pre><code>@article{park2021nerfies,
  author    = {Park, Keunhong and Sinha, Utkarsh and Barron, Jonathan T. and Bouaziz, Sofien and Goldman, Dan B and Seitz, Steven M. and Martin-Brualla, Ricardo},
  title     = {Nerfies: Deformable Neural Radiance Fields},
  journal   = {ICCV},
  year      = {2021},
}</code></pre>
  </div>
</section> -->


<footer class="footer">
  <div class="container">
    <!-- <div class="content has-text-centered">
      <a class="icon-link"
         href="./static/videos/nerfies_paper.pdf">
        <i class="fas fa-file-pdf"></i>
      </a>
      <a class="icon-link" href="https://github.com/keunhong" class="external-link" disabled>
        <i class="fab fa-github"></i>
      </a>
    </div> -->
    <div class="columns is-centered">
      <div class="column is-8">
        <div class="content">
          <p>
            We thank the authors of <a href="https://nerfies.github.io/">Nerfies</a> that kindly open sourced the template of this website.
          </p>
        </div>
      </div>
    </div>
  </div>
</footer>

</body>
</html>
